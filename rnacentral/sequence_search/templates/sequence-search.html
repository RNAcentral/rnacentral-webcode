<!--
Copyright [2009-2017] EMBL-European Bioinformatics Institute
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
     http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

{% extends "portal/base.html" %}
{% load staticfiles %}

{% block meta_tags %}
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="RNAcentral sequence similarity search enables searching against a comprehensive collection of non-coding RNA sequences from a consortium of RNA databases"/>
  <meta name="twitter:description" content="RNAcentral sequence similarity search enables searching against a comprehensive collection of non-coding RNA sequences from a consortium of RNA databases"/>
  <meta name="twitter:card" content="RNAcentral sequence similarity search">
  <meta name="twitter:site" content="@RNAcentral">
  <meta name="twitter:creator" content="@RNAcentral">
  <meta name="twitter:title" content="RNAcentral">
  <meta name="twitter:image" content="https://rnacentral.org{% static "img/logo/rnacentral-logo.png" %}">
{% endblock meta_tags %}

{% block title %}
Sequence search
{% endblock %}

{% block content %}
{% verbatim %}
<div ng-app="sequenceSearch" ng-controller="SequenceSearchController" class="ng-cloak" ng-cloak>

  <h1>
    <i class="fa fa-search"></i> Sequence search
    <!-- <small ng-class="(params.searchInProgress && !params.errorMessage) ? '' : 'hidden'">
      <i class="fa fa-spinner fa-spin"></i>
    </small>
    <small id="sequence-search-status">
      {{params.statusMessage}}
    </small> -->
  </h1>

  <div class="col-md-10" style="padding-left: 0;">
    <div class="alert alert-warning">
      The RNAcentral sequence search is undergoing essential maintenance, so new searches cannot be submitted at this time. Apologies for any inconvenience this might cause.
    </div>
  </div>

  <span class="col-md-10 small text-muted clearfix" style="padding-left: 0;">
    <span>
       Local alignment using <a href="http://www.ncbi.nlm.nih.gov/pubmed/23842809" target="_blank" class="help no-icon" data-toggle="tooltip" title="Wheeler and Eddy, 2013">nhmmer</a>
    </span>

    <em class="pull-right">
      <span ng-class="((params.statusMessage === 'Done' || params.statusMessage === 'Error')) ? '' : 'hidden'">
        search took {{ query.elapsedTime }}s
      </span>

      <span ng-bind="'elapsed '+ query.elapsedTime + 's'" ng-class="(params.statusMessage === messages.pending || params.statusMessage === messages.started) ? '' : 'hidden'"></span>
    </em>
  </span>

  <div class="row sequence-search-input">
      <form name="seqQueryForm" novalidate>

        <div class="col-md-10 form-group margin-bottom-5px" style="padding-left: 5px;">
          <textarea class="form-control force-scrollbars"
                    rows="6"
                    placeholder="Enter RNA/DNA sequence (with an optional description in FASTA format) or an RNAcentral ID"
                    name="sequence"
                    id="query-sequence"
                    ng-change="sequenceLookUp()"
                    ng-model="query.sequence"
                    ng-minlength="defaults.minLength"
                    ng-maxlength="defaults.maxLength"
                    ng-pattern="/^(>.+?[\n\r])*?[acgtunwsmkrybdhvx\s]+$|^URS[A-Fa-f0-9]{10}$/i"
                    tabindex="2"
                    required
                    autofocus></textarea>

            <span class="help-block margin-bottom-5px">
              Examples:
              <a href="" ng-click="sequenceSearch('>miRNA hsa-let-7a-1 (URS000004F5D8)\nCUAUACAAUCUACUGUCUUUC')">miRNA hsa-let-7a-1</a>,
              <a href="" ng-click="sequenceSearch('URS000053962A')">SNORD3A</a>,
                            <a href="" ng-click="sequenceSearch('URS000080DFA3')">lysine riboswitch</a>,
              <a href="" ng-click="sequenceSearch('>5S rRNA (URS0000049E57)\nUGCCUGGCGGCCGUAGCGCGGUGGUCCCACCUGACCCCAUGCCGAACUCAGAAGUGAAACGCCGUAGCGCCGAUGGUAGUGUGGGGUCUCCCCAUGCGAGAGUAGGGAACUGCCAGGCAU')">5S rRNA</a>,
              <a href="" ng-click="sequenceSearch('URS000080DDDF')">16S rRNA</a>,
              <a href="" ng-click="sequenceSearch('URS00008120E1')">NKILA lncRNA</a>
              <em>
                <span class="small pull-right" ng-show="seqQueryForm.sequence.$valid && getQueryLength() > 0">{{getQueryLength()}} nts</span>
              </em>
            </span>

            <div class="form-group margin-bottom-0px" ng-class="(seqQueryForm.sequence.$invalid) ? 'has-error' : ''">
              <label class="control-label"
                     for="query-sequence" ng-show="query.submitAttempted && seqQueryForm.sequence.$error.minlength">
                The sequence cannot be shorter than {{ defaults.minLength }} nucleotides
              </label>

              <label class="control-label"
                     for="query-sequence" ng-show="seqQueryForm.sequence.$error.maxlength">
                The sequence cannot be longer than {{ defaults.maxLength }} nucleotides
              </label>

              <label class="control-label"
                     for="query-sequence" ng-show="seqQueryForm.sequence.$error.pattern">
                Please check your input
              </label>
            </div>
        </div>

        <div class="col-md-2">
          <button type="submit" class="btn btn-primary" tabindex="3" ng-click="submitQuery()" ng-disabled="params.searchInProgress && !params.errorMessage">
            <i class="fa fa-search" ng-show="!params.searchInProgress"></i>
            <i class="fa fa-spinner fa-spin" ng-class="(params.searchInProgress && !params.errorMessage) ? '' : 'hidden'"></i> Search
          </button>

          <br>

          <button class="btn btn-default" tabindex="3" ng-click="reset()" ng-show="!params.searchInProgress">
            <i class="fa fa-trash-o"></i>
            Clear
          </button>
        </div>

      </form><!-- /form -->
  </div><!-- /row -->

  <div class="row" ng-show="results.exactMatch.count > 0"><!-- Pulse animation cannot be on the same element as ng-show -->
    <div class="col-md-10">
      <div class="alert alert-success animated pulse margin-bottom-5px" role="alert">
        <i class="fa fa-check-circle text-success" aria-hidden="true"></i> Identical match: <a href="/rna/{{ results.exactMatch.rnacentral_id }}" target="_blank">{{results.exactMatch.description}}</a>
        <span ng-if="results.exactMatch.count > 1">and
          <a href="/search?q={{ results.exactMatch.urs_id }}*" target="_blank">{{ results.exactMatch.count - 1 | number }} other sequence<ng-pluralize count="results.exactMatch.count - 1" when="{'1': '', 'other': 's'}",></ng-pluralize></a>
        </span>
      </div>
    </div>
  </div>

  <div class="row" ng-show="results.infernal.length > 0 && params.infernalSearchDone">
    <div class="col-md-10 margin-bottom-5px">
      <h2 class="margin-bottom-0px">
        Rfam classification
        <small>
          <a href="{{ params.help }}" style="color:inherit;" target="_blank">
            <i class="fa fa-question-circle-o" aria-hidden="true"></i>
          </a>
        </small>
      </h2>

      <div class="table-responsive">
        <table class="table table-hover table-condensed" style="padding-left: 10px; margin-top: 0px;">
          <thead>
            <th><abbr class="help" data-placement="top" title="Rfam family">Family</abbr></th>
            <th><abbr class="help" data-placement="top" title="Rfam accession">Accession</abbr></th>
            <th><abbr class="help" data-placement="top" title="First nucleotide matching Rfam family">Start</abbr></th>
            <th><abbr class="help" data-placement="top" title="Last nucleotide matching Rfam family">End</abbr></th>
            <th><abbr class="help" data-placement="top" title="A measure of similarity between the sequence and the Rfam model (higher is better)">Bit score</abbr></th>
            <th><abbr class="help" data-placement="top" title="The likelihood of getting this match by chance (lower is better)">E-value</abbr></th>
            <th><abbr class="help" data-placement="top" title="+ or - depending on whether the sequence matched in forward or reverse orientation">Strand</abbr></th>
          </thead>
          <tr ng-repeat="rfam_hit in results.infernal">
            <td><a href="https://rfam.org/family/{{ rfam_hit.target_name }}" target="_blank" title="View Rfam family" class="no-icon">{{ rfam_hit.description }}</td>
            <td><a href="https://rfam.org/family/{{ rfam_hit.accession_rfam }}" target="_blank" title="View Rfam family" class="no-icon">{{ rfam_hit.accession_rfam }}</td>
            <td>{{ rfam_hit.seq_from }}</td>
            <td>{{ rfam_hit.seq_to }}</td>
            <td>{{ rfam_hit.score }}</td>
            <td>{{ rfam_hit.e_value }}</td>
            <td>{{ rfam_hit.strand }}</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="row" ng-show="results.infernal.length === 0 && params.infernalSearchDone">
    <div class="col-md-10">
      <p style="margin-top: 10px; margin-bottom: 10px; padding-left: 0;">
        <img src="/static/img/expert-db-logos/rfam.png" class="desaturate" style="width: 80px; vertical-align: bottom; margin-right: 5px;">
        The query sequence did not match any Rfam families. <a href="{{ params.help }}" target="_blank">Learn more &rarr;</a>
      </p>
    </div>
  </div>

  <div class="progress" ng-show="params.searchInProgress && params.progress != 100 && params.statusMessage !== messages.submitting" style="margin-top: 10px; margin-bottom: 10px;">
    <div class="progress-bar progress-bar-primary active" role="progressbar" aria-valuenow="83"
    aria-valuemin="0" aria-valuemax="100" style="min-width: 7em; width:{{ params.progress }}%">
      <span class="margin-left-5px">Searching...</span>
    </div>
  </div>


  <div class="row" ng-show="params.errorMessage">
    <div class="col-md-7">
      <div class="alert alert-danger">
        {{params.errorMessage}}
      </div>
    </div>
  </div>

  <div class="row" ng-show="params.statusMessage === messages.cancelled">
    <div class="col-md-4">
      <div class="alert alert-warning">
        {{params.statusMessage}}
      </div>
    </div>
  </div>

  <div class="row" ng-show="results.hitCount===0">
    <div class="col-md-4">
      <div class="alert alert-warning">
        <strong>No results</strong>
      </div>
    </div>
    <div class="col-md-12">
      <h2>Suggestions</h2>
      <ul>
        <li ng-if="isFilterEnabled()">
          <p>
            <a href="" ng-click="clearFilter()">Cancel results filtering</a> to view all results
          </p>
        </li>
        <li>
          <p>
            Is your sequence in the 3' to 5' direction? <a href="" ng-click="reverseAndRepeatSearch();">Reverse the sequence and search again</a>
          </p>
        </li>
        <li>
          <p>
            If you believe that there should be results, please <a href="" ng-click="feedback()">send us</a> the job id <code>{{ results.id }}</code>
          </p>
        </li>
      </ul>
    </div>
  </div>

  <div class="row" id="affix-parent">
    <div class="col-md-12">

    <div class="alert col-md-4" ng-if="params.statusMessage === messages.getResuts">
      <i class="fa fa-2x fa-spinner fa-spin"></i>
      {{params.statusMessage}}
    </div>

    <h2 ng-show="params.statusMessage === messages.done && results.hitCount > 0" class="margin-bottom-0px margin-top-5px">
      Similar sequences
      <small>
        <span ng-if="results.hitCount == 1">1 sequence</span>
        <span ng-if="results.hitCount > 1">{{ results.entries.length }} out of {{ results.hitCount | number }}</span>
      </small>
    </h2>

    <div class="row" ng-show="(params.statusMessage === messages.done && results.hitCount > 0) || query.filter" style="margin-bottom: 15px;">
      <div class="col-md-12">
        <form ng-submit="filterResults()">
          <div class="form-group">
            <div class="input-group col-md-4 col-sm-12" style="float: left;">
              <input type="text" class="form-control" ng-model="query.filter" id="queryFilter" placeholder="Search within results">
              <div class="input-group-btn">
                <button type="submit" class="btn btn-default help" data-container="body" title="Search within results" data-ng-disabled="!query.filter">
                  <span>Filter</span>
                </button>
                <button class="btn btn-default help" data-container="body" data-ng-disabled="!isFilterEnabled()" ng-click="clearFilter()" title="Clear results filtering">
                  <i style="width: 15px;"></i>
                  <span>Cancel</span>
                </button>
              </div>
            </div>

            <div class="btn-toolbar col-md-8 col-sm-12" role="toolbar">
              <div class="btn-group" role="group">
                <a class="btn btn-default help" data-container="body" ng-click="params.showAlignments = !params.showAlignments" title="Alignments between query and hit sequences">
                  <span ng-if="params.showAlignments">Hide</span>
                  <span ng-if="!params.showAlignments">Show</span>
                  alignments
                </a>
                <a class="btn btn-default help" data-container="body" ng-click="params.showAlignmentStatistics = !params.showAlignmentStatistics" title="E-value, identity and other information about the hits">
                  <span ng-if="params.showAlignmentStatistics">Hide</span>
                  <span ng-if="!params.showAlignmentStatistics">Show</span>
                  details
                </a>
              </div>
              <div class="btn-group">
                <select class="form-control" ng-change="updateOrdering(); fetchJobResults();" ng-model="params.selectedOrdering" ng-options="item.label for item in ordering track by item.label"></select>
              </div>
              <div class="btn-group" role="group">
                <a class="btn btn-default" ng-click="feedback()"><i class="fa fa-comment-o" aria-hidden="true"></i> Feedback</a>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="col-sm-4 col-md-3 hidden-xs text-search-facets" ng-show="params.statusMessage === messages.done && results.hitCount > 0" style="position: sticky; top: 0;">
      <ul class="list-unstyled">
        <li ng-if="results.textSearchError" class="facet" style="white-space: pre-wrap;">
          <div class="alert alert-warning">{{ messages.textSearchError }}</div>
        </li>
        <li class="facet scrollable-facet" ng-repeat="facet in results.facets">
          <div ng-if="facet.label === 'Organisms' || facet.label === 'RNA types' || facet.label === 'Expert databases'">
            <h3 style="margin-top: 0;">
              {{ facet.label }}
            </h3>
            <ul class="list-unstyled text-search-facet-values text-search-facet-overflow force-scrollbars" style="overflow-x: hidden; margin-bottom: 15px;">
              <li ng-repeat="facetValue in facet.facetValues" ng-if="facet.id == 'expert_db'">
                <!-- This is expert_dbs facet -->
                <input type="checkbox" name="facet.label" ng-checked="isFacetApplied(facet.id, facetValue.value)" ng-click="facetToggled(facet.id, facetValue.value)">
                <a href="" ng-click="facetToggled(facet.id, facetValue.value)" class="text-search-facet-link" uib-tooltip-template="'/static/js/components/sequence-search/expert-database-tooltip-template.html'" tooltip-placement="bottom-left">{{ facetValue.label }} <small>({{ facetValue.count | number }})</small></a>
              </li>
              <li ng-repeat="facetValue in facet.facetValues" ng-if="facet.id != 'expert_db'">
                <input type="checkbox" name="facet.label" ng-checked="isFacetApplied(facet.id, facetValue.value)" ng-click="facetToggled(facet.id, facetValue.value)">
                <a href="" ng-click="facetToggled(facet.id, facetValue.value)" class="text-search-facet-link">{{ facetValue.label }} <small>({{ facetValue.count | number }})</small></a>
              </li>
              <small ng-if="facet.label == 'Organisms' && facet.facetValues.length > 10" class="text-muted">Showing top {{ facet.facetValues.length }} organisms</small>
            </ul>
          </div>
        </li>
        <br/>
        <li class="facet scrollable-facet" ng-repeat="facet in results.facets">
          <uib-accordion ng-if="facet.id == 'has_conserved_structure' || facet.id == 'qc_warning_found' || facet.id == 'has_go_annotations' || facet.id == 'has_genomic_coordinates'" class="text-search-foldable-facets">
            <div uib-accordion-group is-open="$ctrl.search.isFacetOpen[facet.id]">
              <uib-accordion-heading>
                <h3>
                  <small><i class="pull-left fa" ng-class="{'fa-minus': $ctrl.search.isFacetOpen[facet.id], 'fa-plus': !$ctrl.search.isFacetOpen[facet.id]}"></i></small>
                  {{ facet.label }}
                </h3>
              </uib-accordion-heading>
              <ul class="list-unstyled text-search-facet-values text-search-facet-overflow force-scrollbars" style="overflow-x: hidden;">
                <li ng-repeat="facetValue in facet.facetValues" ng-if="facet.id != 'expert_db'">
                  <input type="checkbox" name="facet.label" ng-checked="isFacetApplied(facet.id, facetValue.value)" ng-click="facetToggled(facet.id, facetValue.value)">
                  <a href="" ng-click="facetToggled(facet.id, facetValue.value)" class="text-search-facet-link">{{ facetValue.label }} <small>({{ facetValue.count | number }})</small></a>
                </li>
                <small ng-if="facet.id === 'qc_warning_found'">
                  <a class="text-search-facet-help text-muted" ng-href="{{ help.rfam }}"><i class="fa fa-question-circle" aria-hidden="true"></i> Learn more about Rfam annotations in RNAcentral &rarr;</a>
                </small>
                <small ng-if="facet.id === 'has_conserved_structure'">
                  <a class="text-search-facet-help text-muted" ng-href="{{ help.crs }}"><i class="fa fa-question-circle" aria-hidden="true"></i> Learn more about conserved motifs &rarr;</a>
                </small>
                <small ng-if="facet.id === 'has_go_annotations'">
                  <a class="text-search-facet-help text-muted" ng-href="{{ help.go }}"><i class="fa fa-question-circle" aria-hidden="true"></i> Learn more about Gene Ontology annotations &rarr;</a>
                </small>
                <small ng-if="facet.id === 'has_genomic_coordinates'">
                  <a class="text-search-facet-help text-muted" ng-href="{{ help.genomeMapping }}"><i class="fa fa-question-circle" aria-hidden="true"></i> Learn more about genome mapping &rarr;</a>
                </small>
              </ul>
            </div>
          </uib-accordion>
        </li>
      </ul>
      <small class="text-muted">
        Powered by <a href="http://www.ebi.ac.uk/ebisearch/" target="_blank">EBI Search</a>
      </small>
    </div>

    <div id="affix-sibling" class="col-xs-12 col-sm-8 col-md-9" ng-show="params.statusMessage === messages.done && results.hitCount > 0">

      <ul class="list-unstyled sequence-search-results">
        <li ng-repeat="result in results.entries">

          <div class="row">

          <h4 ng-show="result.rnacentral_id.split('_')[0] === results.exactMatch.urs_id" class="result" style="padding-left: 0; margin-left: 0; margin-top: 0; margin-bottom: 5px;">
            <a href="/rna/{{result.rnacentral_id}}" target="_blank" class="help" data-placement="auto right" title="Identical to the query (exact match)"><i class="fa fa-check-circle text-success margin-right-5px" aria-hidden="true"></i> {{result.description}}</a>
          </h4>

          <h4 ng-show="result.rnacentral_id.split('_')[0] !== results.exactMatch.urs_id" class="result" style="padding-left: 0; margin-left: 0; margin-bottom: 5px; margin-top: 0;">
            <a href="/rna/{{result.rnacentral_id}}" target="_blank">{{result.description}}</a>
          </h4>

          <ul class="list-inline small" style="padding-left: 0; margin-left: 0;">
            <li style="margin-bottom: 5px; margin-left: 0; padding-left: 0;" class="text-muted">{{result.rnacentral_id}}</li>
            <li style="display: inline-block; margin-bottom: 5px;" ng-repeat="expert_db in result.fields.expert_db | plaintext">
              <img class="desaturate" style="height: 16px; vertical-align: top;" ng-src="{{ normalizeExpertDbName.nameToImageUrl(expert_db) }}">
            </li>
            <li ng-if="!$first && $index % 5 === 0" class="pull-right" style="margin-bottom: 0;">
              <a href class="text-muted" ng-click="scrollToTop();"><i class="fa fa-arrow-circle-o-up"></i> Back to top</a>
            </li>
          </ul>

          <table class="table table-condensed table-borderless small" ng-show="params.showAlignmentStatistics" style="margin: 0;">
            <tr>
              <td style="padding-left: 0px;">
                <abbr class="help" data-placement="right" title="The likelihood of finding this alignment by chance (lower is better)">E-value</abbr>
                {{formatEvalue(result.e_value)}}
              </td>
              <td>
                <abbr class="help" data-placement="top" title="Percentage of identical nucleotides">Identity</abbr>
                {{result.identity | number:1}}% <small>({{result.match_count}}/{{result.alignment_length}})</small>
              </td>
              <td>
                <abbr class="help" data-placement="top" title="Percentage of the query sequence covered by the alignment">Query coverage</abbr>
                {{result.query_coverage | number:1}}% <small>({{result.nts_count1}}/{{result.query_length}})</<small>
              </td>
              <td>
                <abbr class="help" data-placement="top" title="Percentage of the target sequence covered by the alignment">Subject coverage</abbr>
                {{result.target_coverage | number:1}}% <small>({{result.nts_count2}}/{{result.target_length}})</small>
              </td>
              <td>
                <abbr class="help" data-placement="left" title="Percentage of gaps in the alignment">Gaps</abbr>
                {{result.gaps | number:1}}% <small>({{result.gap_count}}/{{result.alignment_length}})</small>
              </td>
            </tr>
          </table>

            <pre ng-show="params.showAlignments" class="force-scrollbars small col-md-12" style="background-color: #FFFFFF; max-height: 160px; word-wrap: initial;">{{result.alignment}}</pre>
          </div>
        </li>
      </ul>

      <p>
        <small ng-if="results.hitCount > results.entries.length" class="text-muted">Displaying {{results.entries.length}} out of {{results.hitCount | number}} entries</small>
      </p>
      <button class="btn btn-default load-more col-md-3" ng-click="loadMoreResults()" ng-show="results.hitCount > results.entries.length"><i ng-class="searchInProgress ? 'fa fa-spinner fa-spin' : 'hidden'"></i> Load more</button>
      <br />
    </div> <!--/col-md-9 -->
  </div><!-- col-md-12 -->
  </div><!--/row -->
</div><!--/ng-controller -->

{% endverbatim %}
{% endblock content %}
